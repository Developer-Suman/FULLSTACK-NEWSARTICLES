name: Deploy to Local Computer

on:
  push:
    branches:
      - main  # or the branch you want to trigger this workflow

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH key for Windows
        run: |
          # Create the .ssh directory if it doesn't exist
          if (-not (Test-Path -Path "$env:USERPROFILE\.ssh")) {
            New-Item -Path "$env:USERPROFILE\.ssh" -ItemType Directory
          }

          # Write the SSH private key to id_rsa
          $env:SSH_PRIVATE_KEY | Out-File -FilePath "$env:USERPROFILE\.ssh\id_rsa" -Encoding ascii

          # Set permissions for the SSH private key
          icacls "$env:USERPROFILE\.ssh\id_rsa" /inheritance:r /grant:r "${env:USERNAME}:(R,W)"

          # Add the remote host to known_hosts to avoid SSH verification prompts
          ssh-keyscan -H 192.168.1.64 | Out-File -Append -FilePath "$env:USERPROFILE\.ssh\known_hosts"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to Local Computer
        run: |
          # Test SSH connection
          ssh -i "$env:USERPROFILE\.ssh\id_rsa" suman@192.168.1.64 "echo 'Connected successfully!'"

          # Deploy files using rsync
          rsync -avz --delete BackEnd/MASTER-PROJECT-IN-LAYERED-ARCHITECTURE-GENERIC-REPOSITORY/publish/ suman@192.168.1.64:/path/to/deploy/
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Notify Success
        run: echo "Deployment to local computer successful! ðŸŽ‰"
